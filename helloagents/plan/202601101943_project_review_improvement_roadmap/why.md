# 变更提案: 项目评审与改进路线图（VSCode-Switcher）

## 需求背景

当前项目整体方向正确：以 SwiftUI 侧栏 UI + Accessibility(AXUIElement) 实现“列出 VSCode 窗口 + 一键聚焦/热键切换”，并将顺序/别名等用户偏好落在 UserDefaults，符合“最小可用工具”的定位。

但随着功能迭代（热键、平铺、排序、别名等）累积，代码与文档出现一些“可预期会咬人”的点：重复/未使用逻辑、行为不一致、潜在崩溃路径、以及不必要的 AX 调用频率。此路线图目标是在不引入新依赖、不扩展权限范围的前提下，优先把可靠性与可维护性补齐，然后再按需做少量 UX 提升。

## 变更内容

1. **可靠性/正确性优先**：消除潜在崩溃与不一致行为（窗口 ID/字典构建、热键映射语义统一）。
2. **性能与系统调用节制**：减少不必要的 AX 枚举与刷新频率，避免“能用但一直在忙”。
3. **代码结构与可读性**：清理死代码/重复路径；必要时做小规模拆分（不做大重构）。
4. **工程与发布基础**（可选）：修正明显异常的构建配置项，补齐最小化的运行/分发注意点。

（可选增强，不作为本轮必做）
5. **可用性小提升**：搜索/过滤、状态栏入口、平铺行为开关、更多 VSCode 家族支持、UI 文案统一等。

## 影响范围

- **模块:** VSCode-Switcher（单模块）
- **文件（预计）:**
  - `VSCode-Switcher/VSCode_SwitcherApp.swift`（窗口枚举/聚焦/热键/平铺）
  - `VSCode-Switcher/ContentView.swift`（刷新策略、交互与展示）
  - `VSCode-Switcher.xcodeproj/project.pbxproj`（构建配置校正：仅在必要时）
  - `helloagents/project.md`、`helloagents/wiki/modules/vscode-switcher.md`、`helloagents/wiki/arch.md`、`helloagents/wiki/data.md`、`helloagents/CHANGELOG.md`（实现完成后同步）
- **API:** 无对外 API
- **数据:**
  - UserDefaults 现有键继续使用；若移除历史遗留键（如旧编号映射），需明确兼容策略（默认可忽略旧值，不做迁移）。

## 核心场景

### 需求: 热键语义与 UI 一致
**模块:** VSCode-Switcher

#### 场景: 用户看到的热键标签 = 实际热键行为
条件：窗口列表显示前 10 项热键标签。  
- 预期结果：热键触发的目标窗口与列表标注一致（同一排序语义、同一选择规则）。
- 预期结果：不存在“遗留编号映射逻辑”导致的隐藏行为或误导性文案。

### 需求: 窗口列表/顺序持久化不崩溃
**模块:** VSCode-Switcher

#### 场景: AXWindowNumber 缺失/异常时仍稳定运行
条件：AX 调用失败或返回不完整属性（极端情况）。  
- 预期结果：不会因重复 key 或不可用 id 触发崩溃；最多表现为“该窗口不参与顺序/别名绑定”或“弱稳定标识”。
- 预期结果：列表渲染稳定（SwiftUI 的 `ForEach` 不因重复 id 失效）。

### 需求: 刷新策略不做无谓功
**模块:** VSCode-Switcher

#### 场景: 系统通知频繁触发时仍保持轻量
条件：用户频繁切换应用、打开/关闭窗口。  
- 预期结果：只在需要时枚举窗口列表；“仅激活变化”时优先更新 activeWindow，而不是全量重扫。
- 预期结果：诊断信息（如 AX 错误摘要）不应在每次刷新时默认计算，避免重复 AX 调用。

### 需求: 工程配置不阻碍构建与运行
**模块:** VSCode-Switcher

#### 场景: 在目标 macOS 版本范围内可编译/运行
条件：按仓库约定使用 Xcode 构建。  
- 预期结果：`MACOSX_DEPLOYMENT_TARGET` 等关键配置合理，不因明显异常值导致构建/分发阻塞。

## 风险评估

- **风险:** 窗口标识与持久化策略一旦调整，可能影响用户已保存的顺序/别名（错绑或丢失）。  
  **缓解:** 优先保持 `bundleIdentifier + pid + windowNumber` 路径不变；仅在缺失 windowNumber 的边缘场景做“防崩溃”的弱标识与降级。
- **风险:** 减少刷新频率可能导致列表更新不够“实时”。  
  **缓解:** 仅对全量枚举做节制；activeWindow 高亮仍可高频更新；必要时保留手动 Refresh。
- **风险:** 工程配置调整可能与维护者本机 Xcode/系统版本存在差异。  
  **缓解:** 仅提出最小、可验证的改动；在 task 中明确“先确认目标 macOS 版本范围”再改 pbxproj。
